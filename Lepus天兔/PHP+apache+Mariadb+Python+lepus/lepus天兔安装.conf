1.MySQL 5.0及以上(必须,用来存储监控系统采集的数据)

2.Apache 2.2及以上 (必须,WEB服务器运行服务器)

3.PHP 5.3以上 (必须,提供WEB界面支持)

4.Python2 (必须,推荐2.6及以上版本,执行数据采集和报警任务,不支持Python3)

5.Python连接和监控数据库的相关驱动模块包：

MySQLdb for python (Python连接MySQl的接口，用于监控MySQL,此模块必须安装)

cx_oracle for python (Python连接Oracle的接口，非必须,如果需要监控oracle此模块必须安装)

Pymongo for python (Python连接MongoDB的接口，非必须,如果需要监控MongoDB此模块必须安装 )

redis-py for python (Python连接Redis的接口，非必须,如果需要监控Redis此模块必须安装)

一.基本环境安装

安装lepus监控：
安装依赖包：
[root@localhost ~]# yum -y install httpd php mariadb mariadb-server 
安装lepus server需要的依赖包
yum install gcc python-devel mysql-devel net-snmp-devel curl-devel perl-DBI php-gd php-mysql php-bcmath php-mbstring php-xml -y

配置httpd并启动
-- 配置http服务
vi /etc/httpd/conf/httpd.conf
	ServerName 10.31.1.6:80
--重启http服务器
service httpd start

1.5 配置php
[root@localhost ~]# sed -i "s/;date.timezone =/date.timezone = Asia\/Shanghai/g" /etc/php.ini
[root@localhost ~]# sed -i "s#max_execution_time = 30#max_execution_time = 300#g" /etc/php.ini
[root@localhost ~]# sed -i "s#post_max_size = 8M#post_max_size = 32M#g" /etc/php.ini
[root@localhost ~]# sed -i "s#max_input_time = 60#max_input_time = 300#g" /etc/php.ini
[root@localhost ~]# sed -i "s#memory_limit = 128M#memory_limit = 128M#g" /etc/php.ini
[root@localhost ~]# sed -i "/;mbstring.func_overload = 0/ambstring.func_overload = 2\n" /etc/php.ini


非必须装Centos7自带Python 2.7.5
[root@localhost ~]# cd /usr/local/src
wget https://www.python.org/ftp/python/2.7.2/Python-2.7.2.tar.bz2
tar jxf Python-2.7.2.tar.bz2
cd Python-2.7.2
./configure --prefix=/usr/local/python2.7
make && make install


[root@localhost ~]# wget https://pypi.python.org/packages/source/M/MySQL-python/MySQL-python-1.2.5.zip
[root@localhost ~]# yum -y install unzip
[root@localhost ~]# unzip MySQL-python-1.2.5.zip
[root@localhost ~]# which mysql_config
	/usr/bin/mysql_config
[root@localhost ~]# cd MySQL-python-1.2.5
[root@localhost MySQL-python-1.2.5]# vim site.cfg
	mysql_config = /usr/bin/mysql_config
[root@localhost ~]# yum -y install python-setuptools
[root@localhost MySQL-python-1.2.5]# python setup.py build
[root@localhost MySQL-python-1.2.5]# python setup.py install

下载安装包
[root@xiaoge MySQL-python-1.2.5]# cd /usr/local
[root@localhost local]# yum -y install git
[root@localhost local]# git config --global http.sslVerify false
[root@xiaoge local]# git clone https://github.com/ruzuojun/lepus.git
对可执行文件授权，并创建软连接
[root@xiaoge local]# cd lepus
[root@xiaoge lepus]# chmod +x lepus*
[root@xiaoge lepus]# ln -s /usr/local/lepus/lepus /usr/local/sbin/lepus
[root@xiaoge lepus]# ln -s /usr/local/lepus/lepus_monitor /usr/local/sbin/lepus_mointor
在监控机创建监控数据库，并授权
[root@xiaoge lepus]# mysql -uroot -p
创建数据库lepus
MySQL [(none)]> create database lepus default character set utf8;
创建用户并授权localhost连接lepus数据库的权限
MySQL [(none)]> grant select,insert,update,delete,create on lepus.* to 'lepus'@'localhost' identified by '123456';
MySQL [(none)]> grant select,insert,update,delete,create on lepus.* to 'lepus'@'127.0.0.1' identified by '123456';
MySQL [(none)]> flush privileges;

导入SQL文件夹里的初始化SQL文件(表结构和数据文件)
MySQL [lepus]> use lepus;
MySQL [lepus]> source /usr/local/lepus/sql/lepus_table.sql;
MySQL [lepus]> source /usr/local/lepus/sql/lepus_data.sql;
[root@localhost ~ ]# vim /usr/local/lepus/etc/config.ini 
		[monitor_server]
		host="127.0.0.1"
		port=3306
		user="lepus"
		passwd="123456"
		dbname="lepus"

[root@localhost ~]# cp -fr /usr/local/lepus/web/* /var/www/html/
[root@localhost ~]# vim /var/www/html//application/config/database.php
	$db['default']['hostname'] = '127.0.0.1';
	$db['default']['port']     = '3306';
	$db['default']['username'] = 'lepus';
	$db['default']['password'] = '123456';
	$db['default']['database'] = 'lepus';
	$db['default']['dbdriver'] = 'mysql';



监控MySQL主从

-- 被监控端添加监控账号 MySQL 8之前版本添加lepus权限用户指定IP为lepus监控主机
MySQL [(none)]> CREATE USER 'lepus'@'192.168.1.104' IDENTIFIED BY '123456';
MySQL [(none)]> grant select,super,process,reload,show databases,replication client on *.* to 'lepus'@'192.168.1.104' identified by '123456';

-- 被监控添加监控账号 MySQL 8添加lepus权限用户指定IP为lepus监控主机	
mysql> CREATE USER 'lepus'@'192.168.1.104' IDENTIFIED WITH mysql_native_password BY '123456';
mysql> grant select,super,process,reload,show databases,replication client ON *.* TO 'lepus'@'192.168.1.104' WITH GRANT OPTION;
mysql> flush privileges;

查看用户授权和加密方式是否正确
mysql> select host,user,plugin from mysql.user;


监控系统OS
[root@localhost ~]# yum -y install net-snmp*
监控机与被监控机都改为以下配置
[root@localhost ~]# vim /etc/snmp/snmpd.conf
将default改为监控服务器ip将public改成lepus (备注: lepus是*SNMP 团体名)
com2sec notConfigUser  192.168.1.104     lepus 
62行 将systemview 改为all,供所有snmp访问权限
access  notConfigGroup ""      any       noauth    exact  all none none
85行 将#注释符号去掉 
view all    included  .1                               80
	vim /etc/init.d/snmpd
#OPTIONS="-Lsd -Lf /dev/null -p /var/run/snmpd.pid -a" 
OPTIONS="-LS 4 d -p /var/run/snmpd.pid -a"
在监控机上验证SNMP配置是否成功
[root@localhost ~]# snmpwalk -v 1 -c lepus  192.168.1.100
[root@localhost ~]# snmpwalk -v 2c -c lepus  192.168.1.101

[root@localhost ~]# vim /usr/local/lepus/check_os.sh 
在43行后添加
    if [ -z $mem_shared ]; then
    mem_shared=0
    fi
载入数据：
[root@localhost ~]# python /usr/local/lepus/check_os.py

输入lepus监控机IP进入Web
初始用户： admin
初始密码： Lepusadmin
lepus Web界面  点击配置中心====>点击全局设置=====>*监控(开) *监控MySQL(开) *监控OS(开)
监控MySQL (进程：连接：会话：等待)
lepus Web界面  点击配置中心====>点击MySQL======>点击新增(填写被监控主机IP：端口：被监控机授权用户：授权用户密码：标签)
监控OS(监控 进程数：负载：CPU：内存：网络：磁盘)
lepus Web界面  点击配置中心====>点击操作系统======>点击新增(填写被监控主机IP：SNMP团体名：标签)


[root@localhost ~]# vim /usr/share/doc/httpd-2.4.6/httpd-vhosts.conf
<VirtualHost *:80>
    ServerAdmin demo.lepus.cc
    DocumentRoot "/usr/local/lepus/web"
    ServerName demo.lepus.cc
    ServerAlias demo.lepus.cc
    ErrorLog "logs/demo.lepus.cc-error_log"
    CustomLog "logs/demo.lepus.cc-access_log" common
</VirtualHost>